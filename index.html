<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro Pessoal</title>
    <!-- Carrega o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega os ícones do Lucide (CORRIGIDO - removi o script quebrado do lucide-react) -->
    <script src="https://unpkg.com/lucide-icons@latest/dist/lucide.min.js"></script>
    <!-- Carrega o Chart.js (NOVO) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Estilo da fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        /* Garante que o gráfico não fique gigante */
        #dashboard-section canvas {
            max-height: 400px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">

    <!-- Spinner de Carregamento Principal -->
    <div id="loading-spinner" class="flex justify-center items-center h-screen">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div>
    </div>

    <!-- Container de Autenticação (Login/Registro) -->
    <div id="auth-container" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-2xl border border-gray-200">
            
            <!-- Formulário de Login (inicialmente visível) -->
            <form id="login-form">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Login</h2>
                <div id="login-error" class="text-red-500 text-sm mb-4 text-center hidden"></div>
                <div class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="login-email" required class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700">Senha</label>
                        <input type="password" id="login-password" required class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg shadow-md font-semibold hover:bg-blue-700 transition duration-200 flex items-center justify-center mt-6">
                    Entrar
                </button>
                <p class="text-center text-sm text-gray-600 mt-4">
                    Não tem uma conta? 
                    <button type="button" id="show-register" class="font-medium text-blue-600 hover:underline">Registre-se</button>
                </p>
            </form>

            <!-- Formulário de Registro (inicialmente oculto) -->
            <form id="register-form" class="hidden">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Criar Conta</h2>
                <div id="register-error" class="text-red-500 text-sm mb-4 text-center hidden"></div>
                <div class="space-y-4">
                    <div>
                        <label for="register-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="register-email" required class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-medium text-gray-700">Senha</label>
                        <input type="password" id="register-password" required class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="register-confirm-password" class="block text-sm font-medium text-gray-700">Confirmar Senha</label>
                        <input type="password" id="register-confirm-password" required class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white px-4 py-3 rounded-lg shadow-md font-semibold hover:bg-green-700 transition duration-200 flex items-center justify-center mt-6">
                    Criar Conta
                </button>
                <p class="text-center text-sm text-gray-600 mt-4">
                    Já tem uma conta? 
                    <button type="button" id="show-login" class="font-medium text-blue-600 hover:underline">Faça Login</button>
                </p>
            </form>

        </div>
    </div>
    
    <!-- Container Principal do Aplicativo (Oculto até o login) -->
    <main id="app-container" class="hidden container mx-auto max-w-4xl p-4 md:p-8">
        <header class="mb-8">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <h1 class="text-4xl font-bold text-gray-800 text-left">Meu Controle</h1>
                <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
                    <p class="text-gray-600 text-sm">Usuário: <span id="user-email-display" class="font-mono bg-gray-200 px-2 py-1 rounded">...</span></p>
                    <button id="logout-button" class="bg-red-500 text-white px-3 py-2 rounded-lg shadow-md font-semibold hover:bg-red-600 transition duration-200 flex items-center justify-center text-sm">
                        <i data-lucide="log-out" class="mr-2 h-4 w-4"></i>
                        Sair
                    </button>
                </div>
            </div>
        </header>

        <!-- Conteúdo do Aplicativo -->
        <div id="app-content">
            
            <!-- Seção de Resumo -->
            <section id="summary-section" class="mb-8 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-sm font-medium text-gray-500">Total Previsto (Mês)</h3>
                    <p id="total-previsto" class="text-3xl font-semibold text-blue-600">R$ 0,00</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-sm font-medium text-gray-500">Total Pago (Mês)</h3>
                    <p id="total-pago" class="text-3xl font-semibold text-green-600">R$ 0,00</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-sm font-medium text-gray-500">Restante a Pagar</h3>
                    <p id="total-restante" class="text-3xl font-semibold text-red-600">R$ 0,00</p>
                </div>
            </section>

            <!-- NOVO: Seção do Dashboard (Gráfico) -->
            <section id="dashboard-section" class="mb-8 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <h2 class="text-2xl font-semibold mb-4">Composição das Despesas</h2>
                <div class="relative h-64 md:h-80">
                    <canvas id="expense-pie-chart"></canvas>
                </div>
            </section>

            <!-- Seção para Adicionar Nova Conta Fixa -->
            <section id="add-expense-section" class="mb-8 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <h2 class="text-2xl font-semibold mb-4">Adicionar Nova Conta Fixa</h2>
                <form id="add-expense-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div class="md:col-span-1">
                        <label for="expense-name" class="block text-sm font-medium text-gray-700">Nome da Conta</label>
                        <input type="text" id="expense-name" placeholder="Ex: Aluguel, Luz, Internet" class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="md:col-span-1">
                        <label for="expense-value" class="block text-sm font-medium text-gray-700">Valor Previsto (R$)</label>
                        <input type="number" id="expense-value" step="0.01" placeholder="150.00" class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <!-- NOVO: Campo Dia do Vencimento -->
                    <div class="md:col-span-1">
                        <label for="expense-due-date" class="block text-sm font-medium text-gray-700">Dia do Vencimento</label>
                        <input type="number" id="expense-due-date" min="1" max="31" placeholder="Ex: 10" class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="md:col-span-1">
                        <button type="submit" class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg shadow-md font-semibold hover:bg-blue-700 transition duration-200 flex items-center justify-center">
                            <i data-lucide="plus" class="mr-2 h-5 w-5"></i>
                            Adicionar Conta
                        </button>
                    </div>
                </form>
            </section>

            <!-- Seção da Lista de Contas -->
            <section id="expense-list-section">
                <!-- NOVO: Navegação de Mês -->
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Minhas Contas</h2>
                    <div class="flex items-center gap-2">
                        <button id="prev-month-btn" class="p-2 rounded-md bg-gray-200 hover:bg-gray-300 transition-colors">
                            <i data-lucide="chevron-left" class="h-5 w-5"></i>
                        </button>
                        <span id="current-month" class="font-semibold text-lg text-gray-700 w-36 text-center"></span>
                        <button id="next-month-btn" class="p-2 rounded-md bg-gray-200 hover:bg-gray-300 transition-colors">
                            <i data-lucide="chevron-right" class="h-5 w-5"></i>
                        </button>
                    </div>
                </div>
                <div id="expense-list" class="space-y-4">
                    <!-- Contas serão injetadas aqui pelo JavaScript -->
                    <p class="text-gray-500 text-center py-4">Nenhuma conta fixa cadastrada ainda.</p>
                </div>
            </section>

        </div>
    </main>

    <!-- Modal de Alerta Customizado (substituto do alert()) -->
    <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white max-w-sm w-full p-6 rounded-xl shadow-2xl transform transition-all scale-95 opacity-0" id="alert-modal-content">
            <div class="flex items-center">
                <div id="alert-icon-container" class="mr-4">
                    <!-- Ícone será injetado aqui -->
                </div>
                <div class="flex-1">
                    <h4 class="text-lg font-semibold" id="alert-title">Sucesso!</h4>
                    <p class="text-sm text-gray-600" id="alert-message">Operação realizada.</p>
                </div>
            </div>
            <button id="alert-close-btn" class="mt-6 w-full px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                Fechar
            </button>
        </div>
    </div>

    <!-- NOVO: Modal de Edição -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white max-w-md w-full p-6 rounded-xl shadow-2xl transform transition-all scale-95 opacity-0" id="edit-modal-content">
            <h3 class="text-2xl font-semibold mb-6">Editar Conta Fixa</h3>
            <form id="edit-expense-form">
                <input type="hidden" id="edit-expense-id">
                <div class="space-y-4">
                    <div>
                        <label for="edit-expense-name" class="block text-sm font-medium text-gray-700">Nome da Conta</label>
                        <input type="text" id="edit-expense-name" required class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="edit-expense-value" class="block text-sm font-medium text-gray-700">Valor Previsto (R$)</label>
                        <input type="number" id="edit-expense-value" step="0.01" required class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="edit-expense-due-date" class="block text-sm font-medium text-gray-700">Dia do Vencimento</dlabel>
                        <input type="number" id="edit-expense-due-date" min="1" max="31" required class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="mt-6 flex gap-4">
                    <button type="button" id="edit-cancel-btn" class="w-full px-4 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 focus:outline-none">
                        Cancelar
                    </button>
                    <button type="submit" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 focus:outline-none">
                        Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Scripts do Firebase (MANDATÓRIO) -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            Timestamp,
            writeBatch, // NOVO: Para dados iniciais
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Variáveis Globais do Firebase ---
        let db, auth, userId;
        let fixedExpensesCache = []; // Cache local das contas fixas
        let monthlyPaymentsCache = {}; // Cache local dos pagamentos (mapeado por expenseId)
        
        // NOVO: Variáveis de estado do App
        let selectedDate = new Date(); // Controla o mês/ano selecionado
        let expenseChart = null; // Instância do Chart.js
        let isFirstLoad = true; // Para carregar dados iniciais
        const chartColors = [ // Cores para o gráfico
            '#3B82F6', '#10B981', '#EF4444', '#EAB308', '#8B5CF6', '#F97316',
            '#EC4899', '#6366F1', '#14B8A6', '#F59E0B', '#D946EF', '#0EA5E9'
        ];

        // Listeners do Firestore (para podermos "desligar" no logout)
        let expensesListener = null;
        let paymentsListener = null;

        // --- Configuração do Firebase (Suas Chaves) ---
        const firebaseConfig = {
          apiKey: "AIzaSyCkhSVSUsdhWL1SJi6fs2jkZDvWiFZ5zkw",
          authDomain: "meu-controle-financeiro-86f94.firebaseapp.com",
          projectId: "meu-controle-financeiro-86f94",
          storageBucket: "meu-controle-financeiro-86f94.firebasestorage.app",
          messagingSenderId: "688021518065",
          appId: "1:688021518065:web:c703e1549bfdfeb7995b50"
        };
        
        // --- Elementos da UI ---
        const loadingSpinner = document.getElementById('loading-spinner');
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        
        // Forms de Auth
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showLoginBtn = document.getElementById('show-login');
        const showRegisterBtn = document.getElementById('show-register');
        const loginError = document.getElementById('login-error');
        const registerError = document.getElementById('register-error');
        
        // App Principal
        const userEmailDisplay = document.getElementById('user-email-display');
        const logoutButton = document.getElementById('logout-button');
        const addExpenseForm = document.getElementById('add-expense-form');
        const expenseNameInput = document.getElementById('expense-name');
        const expenseValueInput = document.getElementById('expense-value');
        const expenseDueDateInput = document.getElementById('expense-due-date'); // NOVO
        const expenseList = document.getElementById('expense-list');
        const totalPrevistoEl = document.getElementById('total-previsto');
        const totalPagoEl = document.getElementById('total-pago');
        const totalRestanteEl = document.getElementById('total-restante');
        const currentMonthEl = document.getElementById('current-month');
        const prevMonthBtn = document.getElementById('prev-month-btn'); // NOVO
        const nextMonthBtn = document.getElementById('next-month-btn'); // NOVO
        
        // Modal de Alerta
        const alertModal = document.getElementById('alert-modal');
        const alertModalContent = document.getElementById('alert-modal-content');
        const alertTitle = document.getElementById('alert-title');
        const alertMessage = document.getElementById('alert-message');
        const alertIconContainer = document.getElementById('alert-icon-container');
        const alertCloseBtn = document.getElementById('alert-close-btn');

        // NOVO: Elementos do Modal de Edição
        const editModal = document.getElementById('edit-modal');
        const editModalContent = document.getElementById('edit-modal-content');
        const editExpenseForm = document.getElementById('edit-expense-form');
        const editExpenseId = document.getElementById('edit-expense-id');
        const editExpenseName = document.getElementById('edit-expense-name');
        const editExpenseValue = document.getElementById('edit-expense-value');
        const editExpenseDueDate = document.getElementById('edit-expense-due-date');
        const editCancelBtn = document.getElementById('edit-cancel-btn');

        alertCloseBtn.addEventListener('click', () => {
            alertModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => alertModal.classList.add('hidden'), 150);
        });

        // NOVO: Funções do Modal de Edição
        function openEditModal(expense) {
            editExpenseId.value = expense.id;
            editExpenseName.value = expense.name;
            editExpenseValue.value = expense.estimatedValue;
            editExpenseDueDate.value = expense.dueDate || ''; // Pega o dueDate
            
            editModal.classList.remove('hidden');
            setTimeout(() => {
                editModalContent.classList.remove('scale-95', 'opacity-0');
            }, 50);
        }

        function closeEditModal() {
            editModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                editModal.classList.add('hidden');
                editExpenseForm.reset(); // Limpa o formulário
            }, 150);
        }

        editCancelBtn.addEventListener('click', closeEditModal);

        // --- Funções de Alerta ---
        function showAlert(message, isError = false) {
            alertTitle.textContent = isError ? 'Erro!' : 'Sucesso!';
            alertMessage.textContent = message;

            if (isError) {
                alertIconContainer.innerHTML = `<i data-lucide="alert-triangle" class="h-8 w-8 text-red-500"></i>`;
                alertCloseBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                alertCloseBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            } else {
                alertIconContainer.innerHTML = `<i data-lucide="check-circle" class="h-8 w-8 text-green-500"></i>`;
                alertCloseBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                alertCloseBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }
            lucide.createIcons();
            alertModal.classList.remove('hidden');
            setTimeout(() => {
                alertModalContent.classList.remove('scale-95', 'opacity-0');
            }, 50);
        }

        // Mostra erros nos formulários de login/registro
        function showAuthError(type, message) {
            const el = (type === 'login') ? loginError : registerError;
            el.textContent = message;
            el.classList.remove('hidden');
        }
        
        // Limpa erros
        function clearAuthErrors() {
            loginError.classList.add('hidden');
            registerError.classList.add('hidden');
        }

        // --- Funções Auxiliares ---
        // MODIFICADO: Retorna o MM-YYYY da data selecionada
        function getMonthYear(date) {
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${month}-${year}`;
        }
        // MODIFICADO: Retorna o nome do mês da data selecionada
        function getMonthYearName(date) {
            return date.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
        }
        function formatCurrency(value) {
            return parseFloat(value || 0).toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });
        }
        function getCollectionPath(collectionName) {
            if (!userId) {
                console.error("User ID não definido.");
                return null;
            }
            return `users/${userId}/${collectionName}`;
        }

        // --- Inicialização do Firebase ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug'); 
                await setPersistence(auth, browserLocalPersistence);
                setupAuthListener();
            } catch (error) {
                console.error("Erro inicializando o Firebase:", error);
                loadingSpinner.innerHTML = `<p class="text-red-500">Erro ao carregar. Tente recarregar a página.</p>`;
            }
        }

        // --- Gerenciamento de Autenticação ---
        function setupAuthListener() {
            onAuthStateChanged(auth, (user) => {
                loadingSpinner.classList.add('hidden'); // Esconde o spinner principal
                
                if (user) {
                    // Usuário está logado
                    userId = user.uid;
                userEmailDisplay.textContent = user.email;
                // MODIFICADO: Atualiza o display do mês
                currentMonthEl.textContent = getMonthYearName(selectedDate);
                
                authContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    
                    loadData(); // Carrega os dados do usuário
                    lucide.createIcons(); // Renderiza ícones do app
                } else {
                    // Usuário está deslogado
                    userId = null;
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                
                detachDataListeners(); // Para de ouvir dados antigos
                clearLocalCache(); // Limpa dados da tela
                lucide.createIcons(); // Renderiza ícones do auth
            }
        });
    }
            });
        }
        
        // Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearAuthErrors();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged vai cuidar de mostrar o app
            } catch (error) {
                console.error("Erro de login:", error.code);
                showAuthError('login', 'Email ou senha inválidos.');
            }
        });
        
        // Registro
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearAuthErrors();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;

            if (password !== confirmPassword) {
                showAuthError('register', 'As senhas não conferem.');
                return;
            }
            
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged vai cuidar de mostrar o app
            } catch (error)
 {
                console.error("Erro de registro:", error.code);
                if (error.code === 'auth/email-already-in-use') {
                    showAuthError('register', 'Este email já está em uso.');
                } else if (error.code === 'auth/weak-password') {
                    showAuthError('register', 'A senha deve ter pelo menos 6 caracteres.');
                } else {
                    showAuthError('register', 'Erro ao criar conta.');
                }
            }
        });

        // Logout
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // onAuthStateChanged vai cuidar de mostrar a tela de login
            } catch (error) {
                console.error("Erro ao sair:", error);
                showAlert("Erro ao tentar sair.", true);
            }
        });

        // Alternar entre forms de login/registro
        showRegisterBtn.addEventListener('click', () => {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            clearAuthErrors();
        });
        showLoginBtn.addEventListener('click', () => {
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            clearAuthErrors();
        });
        
        // --- Gerenciamento de Dados (Firestore) ---
        
        // Para de ouvir os snapshots
        function detachDataListeners() {
            if (expensesListener) {
                expensesListener(); // Chama a função 'unsubscribe'
                expensesListener = null;
                console.log("Listener de Contas Fixas desligado.");
            }
            if (paymentsListener) {
                paymentsListener(); // Chama a função 'unsubscribe'
                paymentsListener = null;
                console.log("Listener de Pagamentos desligado.");
            }
        }
        
        // Limpa os dados locais (chamado no logout)
        function clearLocalCache() {
            fixedExpensesCache = [];
            monthlyPaymentsCache = {};
            selectedDate = new Date(); // Reseta a data
            isFirstLoad = true; // Permite carregar dados iniciais para o próximo login
            renderApp(); // Renderiza o app (que agora estará vazio)
        }

        // Carrega dados (contas fixas e pagamentos do mês)
        async function loadData() {
            if (!db || !userId) return;
            
            // Garante que listeners antigos sejam desligados antes de ligar novos
            detachDataListeners();
            
            const expensesPath = getCollectionPath('fixedExpenses');
            if (!expensesPath) return;

            // 1. Listener para Contas Fixas
            const qExpenses = query(collection(db, expensesPath));
            expensesListener = onSnapshot(qExpenses, (querySnapshot) => {
                console.log("Snapshot de Contas Fixas recebido.");
                fixedExpensesCache = [];
                querySnapshot.forEach((doc) => {
                    fixedExpensesCache.push({ id: doc.id, ...doc.data() });
                });
                
                // NOVO: Adiciona contas predefinidas se for o primeiro acesso e não houver contas
                if (querySnapshot.empty && isFirstLoad) {
                    addPredefinedExpenses();
                }
                isFirstLoad = false; // Garante que só rode uma vez

                fixedExpensesCache.sort((a, b) => (a.dueDate || 0) - (b.dueDate || 0));
                renderApp();
            }, (error) => {
                console.error("Erro ao ouvir contas fixas: ", error);
                showAlert("Erro ao carregar contas fixas.", true);
            });

            // 2. Listener para Pagamentos do Mês Atual
            const paymentsPath = getCollectionPath('monthlyPayments');
            // MODIFICADO: Usa a data selecionada (selectedDate)
            const currentMonth = getMonthYear(selectedDate);
            const qPayments = query(collection(db, paymentsPath), where("monthYear", "==", currentMonth));
            paymentsListener = onSnapshot(qPayments, (querySnapshot) => {
                console.log("Snapshot de Pagamentos recebido.");
                monthlyPaymentsCache = {};
                querySnapshot.forEach((doc) => {
                    const payment = { id: doc.id, ...doc.data() };
                    monthlyPaymentsCache[payment.expenseId] = payment;
                });
                renderApp();
            }, (error) => {
                console.error("Erro ao ouvir pagamentos: ", error);
                showAlert("Erro ao carregar pagamentos do mês.", true);
            });
        }

        // --- Lógica do Aplicativo (CRUD) ---
        
        // Adiciona uma nova conta fixa
        addExpenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = expenseNameInput.value.trim();
            const estimatedValue = parseFloat(expenseValueInput.value);
            const dueDate = parseInt(expenseDueDateInput.value); // NOVO

            if (!name || isNaN(estimatedValue) || estimatedValue <= 0) {
                showAlert("Por favor, preencha o nome e um valor válido.", true);
                return;
            }

            if (isNaN(dueDate) || dueDate < 1 || dueDate > 31) {
                showAlert("Por favor, insira um dia de vencimento válido (1-31).", true);
                return;
            }

            try {
                const expensesPath = getCollectionPath('fixedExpenses');
                await addDoc(collection(db, expensesPath), {
                    name: name,
                    estimatedValue: estimatedValue,
                    dueDate: dueDate, // NOVO
                    createdAt: Timestamp.now()
                });
                
                showAlert(`Conta "${name}" adicionada com sucesso!`);
                addExpenseForm.reset();
            } catch (error) {
                console.error("Erro ao adicionar conta:", error);
                showAlert("Erro ao salvar a nova conta.", true);
            }
        });

        // NOVO: Adiciona contas predefinidas (chamado uma vez)
        async function addPredefinedExpenses() {
            const expensesPath = getCollectionPath('fixedExpenses');
            const batch = writeBatch(db);

            const predefined = [
                { name: "Internet", estimatedValue: 100, dueDate: 10 },
                { name: "Luz", estimatedValue: 150, dueDate: 15 },
                { name: "Gás", estimatedValue: 80, dueDate: 5 },
                { name: "Celular", estimatedValue: 50, dueDate: 20 },
                { name: "IPTU", estimatedValue: 120, dueDate: 10 },
                { name: "Canva", estimatedValue: 35, dueDate: 25 },
            ];

            predefined.forEach(expense => {
                const docRef = doc(collection(db, expensesPath)); // Cria uma nova ref
                batch.set(docRef, { ...expense, createdAt: Timestamp.now() });
            });

            try {
                await batch.commit();
                console.log("Contas predefinidas adicionadas!");
            } catch (error) {
                console.error("Erro ao adicionar contas predefinidas: ", error);
            }
        }

        // Lança um pagamento para o mês atual
        // MODIFICADO: Alterado para "Marcar como Pago"
        async function handlePayExpense(expenseId) {
            // Pega o valor previsto do cache
            const expense = fixedExpensesCache.find(e => e.id === expenseId);
            if (!expense) {
                showAlert("Conta não encontrada.", true);
                return;
            }
            const paidValue = expense.estimatedValue; // Usa o valor previsto

            if (isNaN(paidValue) || paidValue <= 0) {
                showAlert("O valor previsto da conta é inválido.", true);
                return;
            }
            if (monthlyPaymentsCache[expenseId]) {
                showAlert("Esta conta já foi paga este mês.", true);
                return;
            }
            try {
                const paymentsPath = getCollectionPath('monthlyPayments');
                await addDoc(collection(db, paymentsPath), {
                    expenseId: expenseId,
                    paidValue: paidValue,
                    monthYear: getMonthYear(selectedDate), // MODIFICADO: Usa o mês selecionado
                    status: 'paid',
                    paidAt: Timestamp.now()
                });
                showAlert("Conta marcada como paga!");
            } catch (error) {
                console.error("Erro ao registrar pagamento:", error);
                showAlert("Erro ao salvar o pagamento.", true);
            }
        }

        // Exclui uma conta fixa
        async function handleDeleteExpense(expenseId, expenseName) {
            try {
                const docPath = doc(db, getCollectionPath('fixedExpenses'), expenseId);
                await deleteDoc(docPath);
                showAlert(`Conta "${expenseName}" excluída com sucesso.`);
            } catch (error) {
                console.error("Erro ao excluir conta:", error);
                showAlert("Erro ao excluir a conta.", true);
            }
        }
        
        // NOVO: Edita uma conta fixa
        editExpenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = editExpenseId.value;
            const name = editExpenseName.value.trim();
            const estimatedValue = parseFloat(editExpenseValue.value);
            const dueDate = parseInt(editExpenseDueDate.value);

            if (!id || !name || isNaN(estimatedValue) || estimatedValue <= 0 || isNaN(dueDate) || dueDate < 1 || dueDate > 31) {
                showAlert("Por favor, preencha todos os campos corretamente.", true);
                return;
            }

            try {
                const docPath = doc(db, getCollectionPath('fixedExpenses'), id);
                await setDoc(docPath, {
                    name: name,
                    estimatedValue: estimatedValue,
                    dueDate: dueDate,
                }, { merge: true }); // Merge: true preserva o 'createdAt'

                showAlert(`Conta "${name}" atualizada com sucesso!`);
                closeEditModal();
            } catch (error) {
                console.error("Erro ao editar conta:", error);
                showAlert("Erro ao salvar as alterações.", true);
            }
        });

        // Desfaz um pagamento (exclui o registro de pagamento)
        async function handleUndoPayment(paymentId) {
             if (!paymentId) {
                showAlert("ID do pagamento não encontrado.", true);
                return;
            }
            try {
                const docPath = doc(db, getCollectionPath('monthlyPayments'), paymentId);
                await deleteDoc(docPath);
                showAlert("Pagamento desfeito com sucesso.");
            } catch (error) {
                console.error("Erro ao desfazer pagamento:", error);
                showAlert("Erro ao desfazer o pagamento.", true);
            }
        }

        // --- Renderização da UI ---

        // Renderiza o app (lista e resumo) com base nos caches
        function renderApp() {
            // Só renderiza se o app estiver visível
            if (!appContainer.classList.contains('hidden')) {
                renderExpenseList();
                updateSummary();
                renderDashboard(); // NOVO: Chama o render do gráfico
                lucide.createIcons();
            }
        }

        // Atualiza o card de resumo
        function updateSummary() {
            let totalPrevisto = 0;
            let totalPago = 0;

            fixedExpensesCache.forEach(expense => {
                totalPrevisto += expense.estimatedValue;
                const payment = monthlyPaymentsCache[expense.id];
                if (payment) {
                    totalPago += payment.paidValue;
                }
            });

            const totalRestante = totalPrevisto - totalPago;
            totalPrevistoEl.textContent = formatCurrency(totalPrevisto);
            totalPagoEl.textContent = formatCurrency(totalPago);
            totalRestanteEl.textContent = formatCurrency(totalRestante);
            totalRestanteEl.classList.toggle('text-red-600', totalRestante > 0);
            totalRestanteEl.classList.toggle('text-green-600', totalRestante <= 0);
        }

        // NOVO: Renderiza o Gráfico de Pizza
        function renderDashboard() {
            const ctx = document.getElementById('expense-pie-chart');
            if (!ctx) return; 

            const labels = fixedExpensesCache.map(e => e.name);
            const data = fixedExpensesCache.map(e => e.estimatedValue);
            
            const backgroundColors = labels.map((_, i) => chartColors[i % chartColors.length]);

            // Destrói o gráfico antigo, se existir
            if (expenseChart) {
                expenseChart.destroy();
            }

            // Cria o novo gráfico
            expenseChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Valor Previsto',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderWidth: 2,
                        borderColor: '#f9fafb' // bg-gray-50
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    family: "'Inter', sans-serif"
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += formatCurrency(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Renderiza a lista de contas
        function renderExpenseList() {
            expenseList.innerHTML = ''; // Limpa a lista

            if (fixedExpensesCache.length === 0) {
                expenseList.innerHTML = `<p class="text-gray-500 text-center py-4">Nenhuma conta fixa cadastrada ainda.</p>`;
                return;
            }

            fixedExpensesCache.forEach(expense => {
                const payment = monthlyPaymentsCache[expense.id];
                const isPaid = !!payment;

                // NOVO: Lógica de Status
                const today = new Date();
                const currentDay = today.getDate();
                const isCurrentMonth = selectedDate.getMonth() === today.getMonth() && selectedDate.getFullYear() === today.getFullYear();
                const isFutureMonth = selectedDate > today;
                
                let status = 'Pendente';
                let statusColor = 'bg-gray-500 text-gray-100'; // Pendente
                
                if (isPaid) {
                    status = 'Pago';
                    statusColor = 'bg-green-600 text-green-100'; // Pago
                } else if (isCurrentMonth && expense.dueDate < currentDay) {
                    status = 'Atrasado';
                    statusColor = 'bg-red-600 text-red-100'; // Atrasado
                }

                const card = document.createElement('div');
                card.className = `bg-white p-4 rounded-lg shadow-md border flex flex-col md:flex-row items-start md:items-center justify-between gap-4 transition-all ${isPaid ? 'border-green-300 bg-green-50 opacity-90' : 'border-gray-200'}`;
                
                let paymentHtml = '';
                if (isPaid) {
                    paymentHtml = `
                        <div class="flex-shrink-0 text-right w-full md:w-auto space-y-2">
                            <div class="flex items-center justify-end text-green-700">
                                <i data-lucide="check-circle" class="mr-2 h-5 w-5"></i>
                                <span class="font-semibold">Pago: ${formatCurrency(payment.paidValue)}</span>
                            </div>
                             <button data-action="undo" data-payment-id="${payment.id}" class="w-full text-xs text-blue-600 hover:underline">Marcar como Pendente</button>
                        </div>
                    `;
                } else {
                    // NOVO: Esconde o botão de pagar em meses futuros
                    if (isFutureMonth) {
                         paymentHtml = `<p class="text-sm text-gray-500 text-right w-full md:w-auto">Pagamento disponível em ${getMonthYearName(selectedDate)}.</p>`;
                    } else {
                        // NOVO: Botão simples para marcar como pago
                        paymentHtml = `
                            <div class="w-full md:w-auto">
                                <button data-action="pay" data-expense-id="${expense.id}" class="w-full bg-green-600 text-white px-4 py-2 rounded-md shadow-sm font-medium hover:bg-green-700 transition duration-200 flex items-center justify-center text-sm">
                                    <i data-lucide="check" class="mr-1 h-4 w-4"></i>
                                    Marcar como Pago
                                </button>
                            </div>
                        `;
                    }
                }

                card.innerHTML = `
                    <div class="flex-1 w-full md:w-auto">
                        <div class="flex items-center justify-between gap-4">
                            <h3 class="text-lg font-semibold text-gray-800">${expense.name}</h3>
                            <!-- NOVO: Status Badge -->
                            <span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${statusColor}">${status}</span>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">Previsto: ${formatCurrency(expense.estimatedValue)}</p>
                        <p class="text-sm text-gray-500">Vencimento: Dia ${expense.dueDate || 'N/D'}</p>
                    </div>
                    <div class="w-full md:w-auto pt-4 md:pt-0 border-t md:border-t-0 border-gray-200">
                        ${paymentHtml}
                    </div>
                    <!-- NOVO: Botões de Ação (Editar e Excluir) -->
                    <div class="flex gap-2 text-gray-400">
                        <button data-action="edit" data-expense-id="${expense.id}" class="hover:text-blue-500 transition-colors">
                            <i data-lucide="pencil" class="h-5 w-5"></i>
                        </button>
                        <button data-action="delete" data-expense-id="${expense.id}" data-expense-name="${expense.name}" class="hover:text-red-500 transition-colors">
                            <i data-lucide="trash-2" class="h-5 w-5"></i>
                        </button>
                    </div>
                `;
                expenseList.appendChild(card);
            });
        }
        
        // --- Listeners de Eventos da UI ---
        
        // Listener de eventos na lista de contas (para botões de Pagar e Excluir)
        expenseList.addEventListener('click', (e) => {
            const target = e.target.closest('button, form');
            if (!target) return;
            const action = target.dataset.action;

            // MODIFICADO: Não é mais um formulário, é um botão
            if (target.tagName === 'BUTTON' && action === 'pay') {
                e.preventDefault();
                const expenseId = target.dataset.expenseId;
                handlePayExpense(expenseId); // Chama a função modificada
            }
            if (target.tagName === 'BUTTON' && action === 'delete') {
                const expenseId = target.dataset.expenseId;
                const expenseName = target.dataset.expenseName;
                handleDeleteExpense(expenseId, expenseName);
            }
            if (target.tagName === 'BUTTON' && action === 'undo') {
                const paymentId = target.dataset.paymentId;
                handleUndoPayment(paymentId);
            }
            // NOVO: Listener para o botão de editar
            if (target.tagName === 'BUTTON' && action === 'edit') {
                const expenseId = target.dataset.expenseId;
                const expense = fixedExpensesCache.find(e => e.id === expenseId);
                if (expense) {
                    openEditModal(expense);
                }
            }
        });

        // NOVO: Listeners dos botões de Mês
        prevMonthBtn.addEventListener('click', () => {
            selectedDate.setMonth(selectedDate.getMonth() - 1);
            currentMonthEl.textContent = getMonthYearName(selectedDate);
            loadData(); // Recarrega os dados para o novo mês
        });

        nextMonthBtn.addEventListener('click', () => {
            selectedDate.setMonth(selectedDate.getMonth() + 1);
            currentMonthEl.textContent = getMonthYearName(selectedDate);
            loadData(); // Recarrega os dados para o novo mês
        });

        // --- Inicialização ---
        initializeFirebase();

    </script>
</body>
</html>

