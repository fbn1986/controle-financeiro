<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro Pessoal</title>
    <!-- Carrega o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega os ícones do Lucide -->
    <script type="module" src="https://unpkg.com/lucide-react@latest/dist/lucide-react.js"></script>
    <script src="https://unpkg.com/lucide-icons@latest/dist/lucide.min.js"></script>
    <!-- Estilo da fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para o spinner de carregamento */
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">

    <!-- Container Principal -->
    <div class="container mx-auto max-w-4xl p-4 md:p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-800 text-center">Meu Controle Financeiro</h1>
            <p class="text-center text-gray-600 text-sm mt-2">Usuário: <span id="user-id-display" class="font-mono bg-gray-200 px-2 py-1 rounded">Carregando...</span></p>
        </header>

        <!-- Spinner de Carregamento Principal -->
        <div id="loading-spinner" class="flex justify-center items-center h-64">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div>
        </div>

        <!-- Conteúdo do Aplicativo (oculto até carregar) -->
        <main id="app-content" class="hidden">
            
            <!-- Seção de Resumo -->
            <section id="summary-section" class="mb-8 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-sm font-medium text-gray-500">Total Previsto (Mês)</h3>
                    <p id="total-previsto" class="text-3xl font-semibold text-blue-600">R$ 0,00</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-sm font-medium text-gray-500">Total Pago (Mês)</h3>
                    <p id="total-pago" class="text-3xl font-semibold text-green-600">R$ 0,00</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-sm font-medium text-gray-500">Restante a Pagar</h3>
                    <p id="total-restante" class="text-3xl font-semibold text-red-600">R$ 0,00</p>
                </div>
            </section>

            <!-- Seção para Adicionar Nova Conta Fixa -->
            <section id="add-expense-section" class="mb-8 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <h2 class="text-2xl font-semibold mb-4">Adicionar Nova Conta Fixa</h2>
                <form id="add-expense-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div class="md:col-span-1">
                        <label for="expense-name" class="block text-sm font-medium text-gray-700">Nome da Conta</label>
                        <input type="text" id="expense-name" placeholder="Ex: Aluguel, Luz, Internet" class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="md:col-span-1">
                        <label for="expense-value" class="block text-sm font-medium text-gray-700">Valor Previsto (R$)</label>
                        <input type="number" id="expense-value" step="0.01" placeholder="150.00" class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="md:col-span-1">
                        <button type="submit" class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg shadow-md font-semibold hover:bg-blue-700 transition duration-200 flex items-center justify-center">
                            <i data-lucide="plus" class="mr-2 h-5 w-5"></i>
                            Adicionar Conta
                        </button>
                    </div>
                </form>
            </section>

            <!-- Seção da Lista de Contas -->
            <section id="expense-list-section">
                <h2 class="text-2xl font-semibold mb-4">Minhas Contas Fixas (Mês: <span id="current-month"></span>)</h2>
                <div id="expense-list" class="space-y-4">
                    <!-- Contas serão injetadas aqui pelo JavaScript -->
                    <p class="text-gray-500 text-center py-4">Nenhuma conta fixa cadastrada ainda.</p>
                </div>
            </section>

        </main>
    </div>

    <!-- Modal de Alerta Customizado (substituto do alert()) -->
    <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white max-w-sm w-full p-6 rounded-xl shadow-2xl transform transition-all scale-95 opacity-0" id="alert-modal-content">
            <div class="flex items-center">
                <div id="alert-icon-container" class="mr-4">
                    <!-- Ícone será injetado aqui -->
                </div>
                <div class="flex-1">
                    <h4 class="text-lg font-semibold" id="alert-title">Sucesso!</h4>
                    <p class="text-sm text-gray-600" id="alert-message">Operação realizada.</p>
                </div>
            </div>
            <button id="alert-close-btn" class="mt-6 w-full px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                Fechar
            </button>
        </div>
    </div>


    <!-- Scripts do Firebase (MANDATÓRIO) -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            Timestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variáveis Globais do Firebase ---
        let db, auth, userId;
        let fixedExpensesCache = []; // Cache local das contas fixas
        let monthlyPaymentsCache = {}; // Cache local dos pagamentos (mapeado por expenseId)
        
        // --- Constantes e Helpers ---
        
        // !!! IMPORTANTE !!!
        // Configuração do Firebase preenchida com seus dados
        const firebaseConfig = {
          apiKey: "AIzaSyCkhSVSUsdhWL1SJi6fs2jkZDvWiFZ5zkw",
          authDomain: "meu-controle-financeiro-86f94.firebaseapp.com",
          projectId: "meu-controle-financeiro-86f94",
          storageBucket: "meu-controle-financeiro-86f94.firebasestorage.app",
          messagingSenderId: "688021518065",
          appId: "1:688021518065:web:c703e1549bfdfeb7995b50"
        };
        // !!! IMPORTANTE !!!

        
        const loadingSpinner = document.getElementById('loading-spinner');
        const appContent = document.getElementById('app-content');
        const userIdDisplay = document.getElementById('user-id-display');

        const addExpenseForm = document.getElementById('add-expense-form');
        const expenseNameInput = document.getElementById('expense-name');
        const expenseValueInput = document.getElementById('expense-value');
        const expenseList = document.getElementById('expense-list');

        const totalPrevistoEl = document.getElementById('total-previsto');
        const totalPagoEl = document.getElementById('total-pago');
        const totalRestanteEl = document.getElementById('total-restante');
        const currentMonthEl = document.getElementById('current-month');
        
        // Modal de Alerta
        const alertModal = document.getElementById('alert-modal');
        const alertModalContent = document.getElementById('alert-modal-content');
        const alertTitle = document.getElementById('alert-title');
        const alertMessage = document.getElementById('alert-message');
        const alertIconContainer = document.getElementById('alert-icon-container');
        const alertCloseBtn = document.getElementById('alert-close-btn');

        alertCloseBtn.addEventListener('click', () => {
            alertModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => alertModal.classList.add('hidden'), 150);
        });

        // Função para mostrar o modal de alerta customizado
        function showAlert(message, isError = false) {
            alertTitle.textContent = isError ? 'Erro!' : 'Sucesso!';
            alertMessage.textContent = message;

            if (isError) {
                alertIconContainer.innerHTML = `<i data-lucide="alert-triangle" class="h-8 w-8 text-red-500"></i>`;
                alertCloseBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                alertCloseBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            } else {
                alertIconContainer.innerHTML = `<i data-lucide="check-circle" class="h-8 w-8 text-green-500"></i>`;
                alertCloseBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                alertCloseBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }
            
            // Renderiza o ícone do Lucide
            lucide.createIcons();

            alertModal.classList.remove('hidden');
            // Pequeno delay para a animação de entrada
            setTimeout(() => {
                alertModalContent.classList.remove('scale-95', 'opacity-0');
            }, 50);
        }

        // --- Funções Auxiliares ---

        // Retorna o mês e ano atual no formato "MM-YYYY"
        function getCurrentMonthYear() {
            const now = new Date();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const year = now.getFullYear();
            return `${month}-${year}`;
        }
        
        // Retorna o nome do mês e ano por extenso
        function getCurrentMonthYearName() {
            const now = new Date();
            return now.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
        }

        // Formata um número para o padrão monetário BRL
        function formatCurrency(value) {
            return parseFloat(value || 0).toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });
        }

        // Constrói o caminho da coleção privada do usuário
        function getCollectionPath(collectionName) {
            if (!userId) {
                console.error("User ID não definido para construir o caminho do Firestore.");
                return null;
            }
            // Caminho simplificado para o seu banco de dados pessoal
            return `users/${userId}/${collectionName}`;
        }

        // --- Inicialização do Firebase ---

        async function initializeFirebase() {
            try {
                // Verifica se as chaves foram preenchidas (essa verificação agora deve passar)
                if (firebaseConfig.apiKey === "COLE_SUA_API_KEY_AQUI") {
                    showAlert("Erro de Configuração: As chaves do Firebase não foram preenchidas no arquivo HTML.", true);
                    loadingSpinner.innerHTML = `<p class="text-red-500 text-center p-4"><b>Erro:</b> Você precisa editar este arquivo e preencher o objeto 'firebaseConfig' com suas chaves do Firebase.</p>`;
                    return;
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug'); // Habilita logs detalhados do Firestore

                // Configura a persistência de autenticação
                await setPersistence(auth, browserLocalPersistence);

                setupAuthListener();
            } catch (error) {
                console.error("Erro inicializando o Firebase:", error);
                showAlert("Não foi possível conectar ao serviço. Verifique sua conexão e configuração.", true);
                loadingSpinner.innerHTML = `<p class="text-red-500">Erro ao carregar. Tente recarregar a página.</p>`;
            }
        }

        // --- Autenticação ---

        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // Usuário já está logado
                    userId = user.uid;
                    await onUserAuthenticated();
                } else {
                    // Se não há usuário, tenta logar anonimamente
                    try {
                        await signInAnonymously(auth);
                        // O 'onAuthStateChanged' será disparado novamente com o usuário logado
                    } catch (error) {
                        console.error("Erro ao autenticar anonimamente:", error);
                        showAlert("Erro de autenticação. Não será possível salvar seus dados.", true);
                        loadingSpinner.classList.add('hidden');
                    }
                }
            });
        }

        // Chamado quando o usuário está autenticado
        async function onUserAuthenticated() {
            console.log("Usuário anônimo autenticado:", userId);
            userIdDisplay.textContent = userId;
            currentMonthEl.textContent = getCurrentMonthYearName();

            // Carrega os dados e exibe o app
            await loadData();
            
            loadingSpinner.classList.add('hidden');
            appContent.classList.remove('hidden');
            
            // Re-renderiza os ícones do Lucide
            lucide.createIcons();
        }

        // --- Lógica do Firestore ---

        // Carrega dados (contas fixas e pagamentos do mês)
        async function loadData() {
            if (!db || !userId) return;
            
            const expensesPath = getCollectionPath('fixedExpenses');
            if (!expensesPath) return;

            // 1. Listener para Contas Fixas
            const qExpenses = query(collection(db, expensesPath));
            
            onSnapshot(qExpenses, (querySnapshot) => {
                console.log("Snapshot de Contas Fixas recebido.");
                fixedExpensesCache = [];
                querySnapshot.forEach((doc) => {
                    fixedExpensesCache.push({ id: doc.id, ...doc.data() });
                });
                // Ordena por nome
                fixedExpensesCache.sort((a, b) => a.name.localeCompare(b.name));
                renderApp();
            }, (error) => {
                console.error("Erro ao ouvir contas fixas: ", error);
                showAlert("Erro ao carregar contas fixas.", true);
            });

            // 2. Listener para Pagamentos do Mês Atual
            const paymentsPath = getCollectionPath('monthlyPayments');
            const currentMonth = getCurrentMonthYear();
            const qPayments = query(collection(db, paymentsPath), where("monthYear", "==", currentMonth));

            onSnapshot(qPayments, (querySnapshot) => {
                console.log("Snapshot de Pagamentos recebido.");
                monthlyPaymentsCache = {};
                querySnapshot.forEach((doc) => {
                    const payment = { id: doc.id, ...doc.data() };
                    monthlyPaymentsCache[payment.expenseId] = payment;
                });
                renderApp();
            }, (error) => {
                console.error("Erro ao ouvir pagamentos: ", error);
                showAlert("Erro ao carregar pagamentos do mês.", true);
            });
        }

        // Adiciona uma nova conta fixa
        async function handleAddExpense(e) {
            e.preventDefault();
            const name = expenseNameInput.value.trim();
            const estimatedValue = parseFloat(expenseValueInput.value);

            if (!name || isNaN(estimatedValue) || estimatedValue <= 0) {
                showAlert("Por favor, preencha o nome e um valor válido.", true);
                return;
            }

            try {
                const expensesPath = getCollectionPath('fixedExpenses');
                await addDoc(collection(db, expensesPath), {
                    name: name,
                    estimatedValue: estimatedValue,
                    createdAt: Timestamp.now()
                });
                
                showAlert(`Conta "${name}" adicionada com sucesso!`);
                addExpenseForm.reset();
            } catch (error) {
                console.error("Erro ao adicionar conta:", error);
                showAlert("Erro ao salvar a nova conta.", true);
            }
        }

        // Lança um pagamento para o mês atual
        async function handlePayExpense(expenseId, paidValue) {
            if (isNaN(paidValue) || paidValue <= 0) {
                showAlert("Por favor, insira um valor de pagamento válido.", true);
                return;
            }

            // Verifica se já não foi pago
            if (monthlyPaymentsCache[expenseId]) {
                showAlert("Esta conta já foi paga este mês.", true);
                return;
            }

            try {
                const paymentsPath = getCollectionPath('monthlyPayments');
                await addDoc(collection(db, paymentsPath), {
                    expenseId: expenseId,
                    paidValue: paidValue,
                    monthYear: getCurrentMonthYear(),
                    status: 'paid',
                    paidAt: Timestamp.now()
                });
                showAlert("Pagamento registrado com sucesso!");
            } catch (error) {
                console.error("Erro ao registrar pagamento:", error);
                showAlert("Erro ao salvar o pagamento.", true);
            }
        }

        // Exclui uma conta fixa
        async function handleDeleteExpense(expenseId, expenseName) {
            console.log(`Solicitando exclusão de: ${expenseName} (ID: ${expenseId})`);
            
            try {
                const docPath = doc(db, getCollectionPath('fixedExpenses'), expenseId);
                await deleteDoc(docPath);
                showAlert(`Conta "${expenseName}" excluída com sucesso.`);
            } catch (error) {
                console.error("Erro ao excluir conta:", error);
                showAlert("Erro ao excluir a conta.", true);
            }
        }
        
        // Desfaz um pagamento (exclui o registro de pagamento)
        async function handleUndoPayment(paymentId) {
             if (!paymentId) {
                showAlert("ID do pagamento não encontrado.", true);
                return;
            }
            try {
                const docPath = doc(db, getCollectionPath('monthlyPayments'), paymentId);
                await deleteDoc(docPath);
                showAlert("Pagamento desfeito com sucesso.");
            } catch (error) {
                console.error("Erro ao desfazer pagamento:", error);
                showAlert("Erro ao desfazer o pagamento.", true);
            }
        }


        // --- Renderização da UI ---

        // Renderiza o app (lista e resumo) com base nos caches
        function renderApp() {
            if (!appContent.classList.contains('hidden')) {
                renderExpenseList();
                updateSummary();
                // Re-renderiza os ícones do Lucide
                lucide.createIcons();
            }
        }

        // Atualiza o card de resumo
        function updateSummary() {
            let totalPrevisto = 0;
            let totalPago = 0;

            fixedExpensesCache.forEach(expense => {
                totalPrevisto += expense.estimatedValue;
                
                const payment = monthlyPaymentsCache[expense.id];
                if (payment) {
                    totalPago += payment.paidValue;
                }
            });

            const totalRestante = totalPrevisto - totalPago;

            totalPrevistoEl.textContent = formatCurrency(totalPrevisto);
            totalPagoEl.textContent = formatCurrency(totalPago);
            totalRestanteEl.textContent = formatCurrency(totalRestante);
            
            // Atualiza cor do restante
            totalRestanteEl.classList.toggle('text-red-600', totalRestante > 0);
            totalRestanteEl.classList.toggle('text-green-600', totalRestante <= 0);
        }

        // Renderiza a lista de contas
        function renderExpenseList() {
            expenseList.innerHTML = ''; // Limpa a lista

            if (fixedExpensesCache.length === 0) {
                expenseList.innerHTML = `<p class="text-gray-500 text-center py-4">Nenhuma conta fixa cadastrada ainda.</p>`;
                return;
            }

            fixedExpensesCache.forEach(expense => {
                const payment = monthlyPaymentsCache[expense.id];
                const isPaid = !!payment;

                const card = document.createElement('div');
                card.className = `bg-white p-4 rounded-lg shadow-md border flex flex-col md:flex-row items-start md:items-center justify-between gap-4 transition-all ${isPaid ? 'border-green-300 bg-green-50' : 'border-gray-200'}`;
                
                let paymentHtml = '';
                if (isPaid) {
                    // Se estiver PAGO
                    paymentHtml = `
                        <div class="flex-shrink-0 text-right w-full md:w-auto">
                            <div class="flex items-center justify-end text-green-700">
                                <i data-lucide="check-circle" class="mr-2 h-5 w-5"></i>
                                <span class="font-semibold">Pago: ${formatCurrency(payment.paidValue)}</span>
                            </div>
                             <button data-action="undo" data-payment-id="${payment.id}" class="text-xs text-blue-600 hover:underline mt-1">Desfazer</button>
                        </div>
                    `;
                } else {
                    // Se estiver PENDENTE
                    paymentHtml = `
                        <form data-action="pay" data-expense-id="${expense.id}" class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                            <input 
                                type="number" 
                                step="0.01"
                                placeholder="Valor Pago" 
                                value="${expense.estimatedValue.toFixed(2)}"
                                class="pay-value-input px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 w-full sm:w-32"
                            >
                            <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md shadow-sm font-medium hover:bg-green-700 transition duration-200 flex items-center justify-center text-sm">
                                <i data-lucide="dollar-sign" class="mr-1 h-4 w-4"></i>
                                Pagar
                            </button>
                        </form>
                    `;
                }

                card.innerHTML = `
                    <div class="flex-1 w-full md:w-auto">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-800">${expense.name}</h3>
                            <button data-action="delete" data-expense-id="${expense.id}" data-expense-name="${expense.name}" class="ml-4 text-gray-400 hover:text-red-500 transition-colors md:hidden">
                                <i data-lucide="trash-2" class="h-5 w-5"></i>
                            </button>
                        </div>
                        <p class="text-sm text-gray-600">Previsto: ${formatCurrency(expense.estimatedValue)}</p>
                    </div>
                    
                    <div class="w-full md:w-auto pt-4 md:pt-0 border-t md:border-t-0 border-gray-200">
                        ${paymentHtml}
                    </div>
                    
                    <button data-action="delete" data-expense-id="${expense.id}" data-expense-name="${expense.name}" class="text-gray-400 hover:text-red-500 transition-colors hidden md:block">
                        <i data-lucide="trash-2" class="h-5 w-5"></i>
                    </button>
                `;
                
                expenseList.appendChild(card);
            });
        }
        
        // --- Listeners de Eventos da UI ---
        
        // Listener para adicionar conta
        addExpenseForm.addEventListener('submit', handleAddExpense);

        // Listener de eventos na lista de contas (para botões de Pagar e Excluir)
        expenseList.addEventListener('click', (e) => {
            const target = e.target.closest('button, form');
            if (!target) return;

            const action = target.dataset.action;

            if (target.tagName === 'FORM' && action === 'pay') {
                e.preventDefault();
                const expenseId = target.dataset.expenseId;
                const paidValue = parseFloat(target.querySelector('.pay-value-input').value);
                handlePayExpense(expenseId, paidValue);
            }
            
            if (target.tagName === 'BUTTON' && action === 'delete') {
                const expenseId = target.dataset.expenseId;
                const expenseName = target.dataset.expenseName;
                // Idealmente, usaríamos um modal de confirmação.
                handleDeleteExpense(expenseId, expenseName);
            }
            
            if (target.tagName === 'BUTTON' && action === 'undo') {
                const paymentId = target.dataset.paymentId;
                handleUndoPayment(paymentId);
            }
        });

        // --- Inicialização ---
        initializeFirebase();

    </script>
</body>
</html>

