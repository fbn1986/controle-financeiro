<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Meu Controle Financeiro — Upgrade</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide (icons) -->
  <script src="https://unpkg.com/lucide@0.321.0/dist/umd/lucide.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; }
    .modal-enter { transform: scale(.97); opacity: 0; }
    .modal-enter-active { transform: scale(1); opacity: 1; transition: transform .15s ease, opacity .15s ease; }
    .modal-leave { transform: scale(1); opacity: 1; }
    .modal-leave-active { transform: scale(.97); opacity: 0; transition: transform .15s ease, opacity .15s ease; }
  </style>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#4F46E5" /* Indigo-600 */,
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gray-50 text-gray-900">

  <!-- Spinner -->
  <div id="loading-spinner" class="fixed inset-0 flex items-center justify-center">
    <div class="animate-spin rounded-full h-16 w-16 border-4 border-primary border-t-transparent"></div>
  </div>

  <!-- Auth -->
  <div id="auth-container" class="hidden min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-white border border-gray-200 rounded-xl shadow-xl p-6">
      <form id="login-form">
        <h2 class="text-2xl font-bold mb-4 text-center">Entrar</h2>
        <div id="login-error" class="hidden text-sm text-red-600 mb-2"></div>
        <label class="text-sm">Email</label>
        <input id="login-email" type="email" class="w-full mt-1 mb-3 px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary"/>
        <label class="text-sm">Senha</label>
        <input id="login-password" type="password" class="w-full mt-1 mb-4 px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary"/>
        <button class="w-full bg-primary text-white rounded-lg py-2 font-semibold">Entrar</button>
        <p class="text-center text-sm mt-3">Não tem conta?
          <button id="show-register" type="button" class="text-primary hover:underline">Criar</button>
        </p>
      </form>

      <form id="register-form" class="hidden">
        <h2 class="text-2xl font-bold mb-4 text-center">Criar conta</h2>
        <div id="register-error" class="hidden text-sm text-red-600 mb-2"></div>
        <label class="text-sm">Email</label>
        <input id="register-email" type="email" class="w-full mt-1 mb-3 px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary"/>
        <label class="text-sm">Senha</label>
        <input id="register-password" type="password" class="w-full mt-1 mb-3 px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary"/>
        <label class="text-sm">Confirmar senha</label>
        <input id="register-confirm-password" type="password" class="w-full mt-1 mb-4 px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary"/>
        <button class="w-full bg-primary text-white rounded-lg py-2 font-semibold">Cadastrar</button>
        <p class="text-center text-sm mt-3">Já tem conta?
          <button id="show-login" type="button" class="text-primary hover:underline">Entrar</button>
        </p>
      </form>
    </div>
  </div>

  <!-- App -->
  <main id="app-container" class="hidden max-w-6xl mx-auto p-5 space-y-6">
    <header class="flex items-center justify-between flex-wrap gap-4">
      <h1 class="text-3xl font-bold">Meu Controle</h1>
      <div class="flex items-center gap-3">
        <span id="user-email-display" class="px-2 py-1 rounded bg-gray-100 border text-sm">...</span>
        <button id="logout-button" class="bg-red-600 text-white px-3 py-2 rounded-lg flex items-center gap-1">
          <i data-lucide="log-out" class="h-4 w-4"></i> Sair
        </button>
      </div>
    </header>

    <!-- Cards resumo -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-white border rounded-xl p-4 shadow-sm">
        <h4 class="text-sm text-gray-500">Previsto (mês)</h4>
        <p id="total-previsto" class="text-2xl font-bold text-indigo-600">R$ 0,00</p>
      </div>
      <div class="bg-white border rounded-xl p-4 shadow-sm">
        <h4 class="text-sm text-gray-500">Pago (mês)</h4>
        <p id="total-pago" class="text-2xl font-bold text-green-600">R$ 0,00</p>
      </div>
      <div class="bg-white border rounded-xl p-4 shadow-sm">
        <h4 class="text-sm text-gray-500">Restante</h4>
        <p id="total-restante" class="text-2xl font-bold text-red-600">R$ 0,00</p>
      </div>
    </section>

    <!-- Dashboards -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="bg-white border rounded-xl p-5 shadow-sm">
        <h3 class="font-semibold mb-2">Distribuição por contas (pizza)</h3>
        <div class="h-72"><canvas id="chart-pie"></canvas></div>
      </div>
      <div class="bg-white border rounded-xl p-5 shadow-sm">
        <h3 class="font-semibold mb-2">Previsto vs Pago (barras)</h3>
        <div class="h-72"><canvas id="chart-bar"></canvas></div>
      </div>
    </section>

    <!-- Add expense -->
    <section class="bg-white border rounded-xl p-5 shadow-sm space-y-3">
      <h3 class="font-semibold">Adicionar Conta Fixa</h3>
      <form id="add-expense-form" class="grid md:grid-cols-5 gap-3 items-end">
        <div>
          <label class="text-sm">Conta</label>
          <input id="expense-name" class="w-full mt-1 px-3 py-2 bg-gray-50 border rounded-lg"/>
        </div>
        <div>
          <label class="text-sm">Valor (R$)</label>
          <input id="expense-value" type="number" step="0.01" class="w-full mt-1 px-3 py-2 bg-gray-50 border rounded-lg"/>
        </div>
        <div>
          <label class="text-sm">Dia venc.</label>
          <input id="expense-due-date" type="number" min="1" max="31" class="w-full mt-1 px-3 py-2 bg-gray-50 border rounded-lg"/>
        </div>
        <div>
          <label class="text-sm">Categoria</label>
          <select id="expense-category" class="w-full mt-1 px-3 py-2 bg-gray-50 border rounded-lg">
            <option value="Casa">Casa</option>
            <option value="Assinaturas">Assinaturas</option>
            <option value="Utilidades">Utilidades</option>
            <option value="Internet/Telefonia">Internet/Telefonia</option>
            <option value="Impostos">Impostos</option>
            <option value="Outros" selected>Outros</option>
          </select>
        </div>
        <div>
          <label class="text-sm">Notas (opcional)</label>
          <input id="expense-notes" class="w-full mt-1 px-3 py-2 bg-gray-50 border rounded-lg" placeholder="Ex.: Pix, conta conjunta..."/>
        </div>
        <div class="md:col-span-5">
          <button class="bg-primary text-white px-4 py-2 rounded-lg flex items-center gap-2">
            <i data-lucide="plus"></i> Adicionar
          </button>
        </div>
      </form>
    </section>

    <!-- Lista -->
    <section class="bg-white border rounded-xl p-5 shadow-sm">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-3 mb-4">
        <h2 class="text-xl font-semibold">Minhas Contas Fixas</h2>
        <div class="flex items-center gap-2">
          <button id="prev-month-btn" class="bg-gray-100 border px-3 py-2 rounded-lg hover:bg-gray-200" title="Mês anterior">
            <i data-lucide="chevron-left"></i>
          </button>
          <span id="selected-month-display" class="font-medium w-40 text-center">...</span>
          <button id="next-month-btn" class="bg-gray-100 border px-3 py-2 rounded-lg hover:bg-gray-200" title="Mês seguinte">
            <i data-lucide="chevron-right"></i>
          </button>
          <button id="today-btn" class="bg-gray-800 text-white px-3 py-2 rounded-lg hover:bg-gray-700" title="Hoje">
            <i data-lucide="calendar-check-2"></i>
          </button>
        </div>
      </div>

      <!-- Busca + Filtro -->
      <div class="flex flex-col md:flex-row items-center justify-between gap-3 mb-4">
        <input id="expense-search" type="text" placeholder="Buscar conta..." class="w-full md:w-1/2 px-3 py-2 bg-gray-50 border rounded-lg"/>
        <select id="expense-filter" class="w-full md:w-44 px-3 py-2 bg-gray-50 border rounded-lg">
          <option value="all">Todas</option>
          <option value="pending">Pendentes</option>
          <option value="paid">Pagas</option>
          <option value="late">Atrasadas</option>
        </select>
      </div>

      <div id="expense-list" class="space-y-3">
        <p class="text-gray-500 text-center py-4">Nenhuma conta cadastrada.</p>
      </div>
    </section>
  </main>

  <!-- Modal: alerta -->
  <div id="alert-modal" class="hidden fixed inset-0 bg-black/60 z-50">
    <div class="max-w-sm mx-auto mt-40 bg-white p-5 rounded-xl shadow-xl modal-enter" id="alert-modal-content">
      <div class="flex items-start gap-3">
        <div id="alert-icon" class="mt-1"></div>
        <div class="flex-1">
          <h4 id="alert-title" class="font-semibold">Aviso</h4>
          <p id="alert-message" class="text-sm text-gray-700">...</p>
        </div>
      </div>
      <div class="mt-4 text-right">
        <button id="alert-close" class="bg-primary text-white px-4 py-2 rounded-lg">OK</button>
      </div>
    </div>
  </div>

  <!-- Modal: editar pagamento custom -->
  <div id="pay-modal" class="hidden fixed inset-0 bg-black/60 z-50">
    <div class="max-w-sm mx-auto mt-40 bg-white p-5 rounded-xl shadow-xl modal-enter" id="pay-modal-content">
      <h4 class="font-semibold mb-3">Marcar como pago</h4>
      <form id="pay-form" class="space-y-3">
        <input type="hidden" id="pay-expense-id"/>
        <div>
          <label class="text-sm">Valor pago (R$)</label>
          <input id="pay-value" type="number" step="0.01" class="w-full mt-1 px-3 py-2 bg-gray-50 border rounded-lg"/>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="pay-cancel" class="px-3 py-2 rounded-lg border">Cancelar</button>
          <button class="bg-green-600 text-white px-4 py-2 rounded-lg">Confirmar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: editar conta -->
  <div id="edit-modal" class="hidden fixed inset-0 bg-black/60 z-50">
    <div class="max-w-md mx-auto mt-24 bg-white p-5 rounded-xl shadow-xl modal-enter" id="edit-modal-content">
      <h4 class="font-semibold mb-3">Editar Conta</h4>
      <form id="edit-form" class="grid md:grid-cols-2 gap-3">
        <input type="hidden" id="edit-id"/>
        <div class="md:col-span-2">
          <label class="text-sm">Conta</label>
          <input id="edit-name" class="w-full mt-1 px-3 py-2 bg-gray-50 border rounded-lg"/>
        </div>
        <div>
          <label class="text-sm">Valor (R$)</label>
          <input id="edit-value" type="number" step="0.01" class="w-full mt-1 px-3 py-2 bg-gray-50 border rounded-lg"/>
        </div>
        <div>
          <label class="text-sm">Dia venc.</label>
          <input id="edit-due" type="number" min="1" max="31" class="w-full mt-1 px-3 py-2 bg-gray-50 border rounded-lg"/>
        </div>
        <div>
          <label class="text-sm">Categoria</label>
          <select id="edit-category" class="w-full mt-1 px-3 py-2 bg-gray-50 border rounded-lg">
            <option>Casa</option>
            <option>Assinaturas</option>
            <option>Utilidades</option>
            <option>Internet/Telefonia</option>
            <option>Impostos</option>
            <option>Outros</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="text-sm">Notas</label>
          <input id="edit-notes" class="w-full mt-1 px-3 py-2 bg-gray-50 border rounded-lg"/>
        </div>
        <div class="md:col-span-2 flex justify-end gap-2 mt-1">
          <button type="button" id="edit-cancel" class="px-3 py-2 rounded-lg border">Cancelar</button>
          <button class="bg-primary text-white px-4 py-2 rounded-lg">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: confirmação excluir -->
  <div id="confirm-modal" class="hidden fixed inset-0 bg-black/60 z-50">
    <div class="max-w-sm mx-auto mt-40 bg-white p-5 rounded-xl shadow-xl modal-enter" id="confirm-modal-content">
      <h4 class="font-semibold mb-3">Confirmar exclusão</h4>
      <p class="text-sm text-gray-700 mb-4">Tem certeza que deseja excluir a conta <span id="confirm-name" class="font-medium"></span>?</p>
      <div class="flex justify-end gap-2">
        <button id="confirm-cancel" class="px-3 py-2 rounded-lg border">Cancelar</button>
        <button id="confirm-ok" class="bg-red-600 text-white px-4 py-2 rounded-lg">Excluir</button>
      </div>
    </div>
  </div>

  <!-- Firebase + App -->
  <script type="module">
    // Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, doc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot,
      collection, query, where, Timestamp, writeBatch, setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Config (do seu projeto)
    const firebaseConfig = {
      apiKey: "AIzaSyCkhSVSUsdhWL1SJi6fs2jkZDvWiFZ5zkw",
      authDomain: "meu-controle-financeiro-86f94.firebaseapp.com",
      projectId: "meu-controle-financeiro-86f94",
      storageBucket: "meu-controle-financeiro-86f94.firebasestorage.app",
      messagingSenderId: "688021518065",
      appId: "1:688021518065:web:c703e1549bfdfeb7995b50"
    };

    // Globals
    let db, auth, userId;
    let expensesListener=null, paymentsListener=null;
    let fixedExpensesCache = [];                // [{id, name, estimatedValue, dueDate, category, notes}]
    let monthlyPaymentsCache = {};              // {expenseId -> {id, paidValue, monthYear}}
    let selectedDate = new Date();

    // UI els
    const $ = (id)=>document.getElementById(id);
    const loadingSpinner = $("loading-spinner");
    const authContainer = $("auth-container");
    const appContainer = $("app-container");
    const loginForm = $("login-form");
    const registerForm = $("register-form");
    const showLoginBtn = $("show-login");
    const showRegisterBtn = $("show-register");
    const loginError = $("login-error");
    const registerError = $("register-error");
    const userEmailDisplay = $("user-email-display");
    const logoutButton = $("logout-button");

    const addExpenseForm = $("add-expense-form");
    const expenseNameInput = $("expense-name");
    const expenseValueInput = $("expense-value");
    const expenseDueInput  = $("expense-due-date");
    const expenseCategoryInput = $("expense-category");
    const expenseNotesInput = $("expense-notes");

    const totalPrevistoEl = $("total-previsto");
    const totalPagoEl = $("total-pago");
    const totalRestanteEl = $("total-restante");

    const prevMonthBtn = $("prev-month-btn");
    const nextMonthBtn = $("next-month-btn");
    const todayBtn = $("today-btn");
    const monthDisplay = $("selected-month-display");

    const expenseList = $("expense-list");

    // Modals
    const alertModal = $("alert-modal");
    const alertContent = $("alert-modal-content");
    const alertIcon = $("alert-icon");
    const alertTitle = $("alert-title");
    const alertMessage = $("alert-message");
    $("alert-close").onclick = () => closeModal(alertModal, alertContent);

    const payModal = $("pay-modal");
    const payContent = $("pay-modal-content");
    const payForm = $("pay-form");
    const payExpenseId = $("pay-expense-id");
    const payValue = $("pay-value");
    $("pay-cancel").onclick = () => closeModal(payModal, payContent);

    const editModal = $("edit-modal");
    const editContent = $("edit-modal-content");
    const editForm = $("edit-form");
    const editId = $("edit-id");
    const editName = $("edit-name");
    const editValue = $("edit-value");
    const editDue = $("edit-due");
    const editCategory = $("edit-category");
    const editNotes = $("edit-notes");
    $("edit-cancel").onclick = () => closeModal(editModal, editContent);

    const confirmModal = $("confirm-modal");
    const confirmContent = $("confirm-modal-content");
    const confirmName = $("confirm-name");
    const confirmCancel = $("confirm-cancel");
    const confirmOk = $("confirm-ok");

    // Busca + filtro
    const searchInput = $("expense-search");
    const filterSelect = $("expense-filter");
    let searchTerm = "";
    let filterStatus = "all";

    searchInput.addEventListener("input", (e)=>{ searchTerm = e.target.value.toLowerCase(); renderExpenseList(); });
    filterSelect.addEventListener("change", (e)=>{ filterStatus = e.target.value; renderExpenseList(); });

    // Charts
    let chartPie=null, chartBar=null;
    const chartColors = ['#4F46E5','#10B981','#EF4444','#F59E0B','#8B5CF6','#EC4899','#14B8A6','#6366F1','#F97316','#06B6D4'];

    // Helpers
    function formatCurrency(v){ return parseFloat(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
    function getMonthYear(d){ const m=(d.getMonth()+1).toString().padStart(2,'0'); return `${m}-${d.getFullYear()}`; }
    function getMonthYearName(d){ return d.toLocaleString('pt-BR',{month:'long',year:'numeric'}); }
    function openModal(container,content){ container.classList.remove("hidden"); content.classList.add("modal-enter"); requestAnimationFrame(()=>{content.classList.add("modal-enter-active");}); }
    function closeModal(container,content){ content.classList.remove("modal-enter-active"); content.classList.add("modal-leave-active"); setTimeout(()=>{container.classList.add("hidden"); content.classList.remove("modal-leave-active"); content.classList.remove("modal-enter");},150); }

    function showAlert(msg, ok=true){
      alertTitle.textContent = ok ? "Tudo certo" : "Erro";
      alertMessage.textContent = msg;
      alertIcon.innerHTML = ok ? `<i data-lucide="check-circle" class="text-green-600 h-6 w-6"></i>`
                               : `<i data-lucide="alert-triangle" class="text-red-600 h-6 w-6"></i>`;
      if (window.lucide) lucide.createIcons();
      openModal(alertModal, alertContent);
    }

    // Init Firebase
    async function init(){
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      setLogLevel("error");
      await setPersistence(auth, browserLocalPersistence);
      onAuthStateChanged(auth, (user)=>{
        loadingSpinner.classList.add("hidden");
        if (user){
          userId = user.uid;
          userEmailDisplay.textContent = user.email;
          authContainer.classList.add("hidden");
          appContainer.classList.remove("hidden");
          monthDisplay.textContent = getMonthYearName(selectedDate);
          attachListeners();
          if (window.lucide) lucide.createIcons();
        }else{
          userId = null;
          appContainer.classList.add("hidden");
          authContainer.classList.remove("hidden");
          detachListeners();
        }
      });
    }

    // Auth
    loginForm.onsubmit = async (e)=>{
      e.preventDefault();
      loginError.classList.add("hidden");
      try{
        const email = $("login-email").value;
        const pass = $("login-password").value;
        await signInWithEmailAndPassword(auth,email,pass);
      }catch(err){
        loginError.textContent = "Email ou senha inválidos.";
        loginError.classList.remove("hidden");
      }
    };
    registerForm.onsubmit = async (e)=>{
      e.preventDefault();
      registerError.classList.add("hidden");
      try{
        const email = $("register-email").value;
        const pass = $("register-password").value;
        const conf = $("register-confirm-password").value;
        if (pass!==conf){ registerError.textContent="As senhas não conferem."; registerError.classList.remove("hidden"); return; }
        await createUserWithEmailAndPassword(auth,email,pass);
      }catch(err){
        registerError.textContent = err?.code==="auth/email-already-in-use" ? "Este email já está em uso." : "Erro ao criar conta.";
        registerError.classList.remove("hidden");
      }
    };
    showRegisterBtn.onclick = ()=>{ loginForm.classList.add("hidden"); registerForm.classList.remove("hidden"); };
    showLoginBtn.onclick    = ()=>{ registerForm.classList.add("hidden"); loginForm.classList.remove("hidden"); };
    logoutButton.onclick    = async ()=>{ try{ await signOut(auth); }catch{ showAlert("Erro ao sair", false); } };

    // Firestore paths
    const colPath = (name)=>`users/${userId}/${name}`;

    function detachListeners(){
      if (expensesListener){ expensesListener(); expensesListener=null; }
      if (paymentsListener){ paymentsListener(); paymentsListener=null; }
      fixedExpensesCache=[]; monthlyPaymentsCache={};
      renderAll();
    }

    async function attachListeners(){
      // Expenses
      if (expensesListener){ expensesListener(); }
      expensesListener = onSnapshot(query(collection(db,colPath("fixedExpenses"))), (snap)=>{
        fixedExpensesCache = [];
        snap.forEach(d=> fixedExpensesCache.push({id:d.id, ...d.data()}));
        // Normaliza campos ausentes
        fixedExpensesCache.forEach(e=>{
          if (e.category===undefined) e.category = "Outros";
          if (e.notes===undefined) e.notes = "";
        });
        fixedExpensesCache.sort((a,b)=> (a.dueDate||99) - (b.dueDate||99));
        renderAll();
      });

      // Payments for selected month
      subscribePaymentsFor(selectedDate);
    }

    function subscribePaymentsFor(date){
      if (paymentsListener) paymentsListener();
      paymentsListener = onSnapshot(
        query(collection(db,colPath("monthlyPayments")), where("monthYear","==",getMonthYear(date))),
        (snap)=>{
          monthlyPaymentsCache = {};
          snap.forEach(d=>{
            const p = {id:d.id, ...d.data()};
            monthlyPaymentsCache[p.expenseId] = p;
          });
          renderAll();
        }
      );
    }

    // CRUD UI handlers
    addExpenseForm.onsubmit = async (e)=>{
      e.preventDefault();
      const name = expenseNameInput.value.trim();
      const val  = parseFloat(expenseValueInput.value);
      const due  = parseInt(expenseDueInput.value);
      const cat  = expenseCategoryInput.value || "Outros";
      const notes = expenseNotesInput.value.trim();

      if (!name || isNaN(val) || val<=0 || isNaN(due) || due<1 || due>31){
        showAlert("Preencha conta, valor válido e dia 1-31.", false);
        return;
      }
      try{
        await addDoc(collection(db,colPath("fixedExpenses")), {
          name, estimatedValue: val, dueDate: due, category: cat, notes, createdAt: Timestamp.now()
        });
        addExpenseForm.reset();
        showAlert(`Conta "${name}" adicionada!`);
      }catch{
        showAlert("Erro ao salvar a conta.", false);
      }
    };

    // Edit modal
    editForm.onsubmit = async (e)=>{
      e.preventDefault();
      const id = editId.value;
      const name = editName.value.trim();
      const val  = parseFloat(editValue.value);
      const due  = parseInt(editDue.value);
      const cat  = editCategory.value || "Outros";
      const notes= editNotes.value.trim();

      if (!id || !name || isNaN(val)||val<=0 || isNaN(due)|| due<1||due>31){
        showAlert("Preencha corretamente os campos.", false);
        return;
      }
      try{
        await updateDoc(doc(db,colPath("fixedExpenses"),id), { name, estimatedValue: val, dueDate: due, category: cat, notes });
        closeModal(editModal, editContent);
        showAlert("Conta atualizada!");
      }catch{
        showAlert("Erro ao atualizar.", false);
      }
    };

    // Pay modal
    payForm.onsubmit = async (e)=>{
      e.preventDefault();
      const id = payExpenseId.value;
      const val= parseFloat(payValue.value);
      if (!id || isNaN(val)||val<=0){ showAlert("Informe um valor válido.", false); return; }
      if (monthlyPaymentsCache[id]){ showAlert("Já está pago neste mês.", false); return; }
      try{
        await addDoc(collection(db,colPath("monthlyPayments")), {
          expenseId: id, paidValue: val, monthYear: getMonthYear(selectedDate), status: "paid", paidAt: Timestamp.now()
        });
        closeModal(payModal, payContent);
        showAlert("Pagamento registrado!");
      }catch{
        showAlert("Erro ao registrar pagamento.", false);
      }
    };

    // Month nav
    prevMonthBtn.onclick = ()=> changeMonth(-1);
    nextMonthBtn.onclick = ()=> changeMonth( 1);
    todayBtn.onclick     = ()=> changeMonth( 0, true);
    function changeMonth(dir, reset=false){
      const now = new Date();
      if (reset){ selectedDate = new Date(); }
      else { selectedDate.setMonth(selectedDate.getMonth()+dir); }
      if (selectedDate > now && dir>0){ selectedDate = new Date(now.getFullYear(), now.getMonth(), 1); showAlert("Não é possível visualizar meses futuros.", false); }
      monthDisplay.textContent = getMonthYearName(selectedDate);
      subscribePaymentsFor(selectedDate);
    }

    // Render
    function renderAll(){
      renderSummary();
      renderCharts();
      renderExpenseList();
      if (window.lucide) lucide.createIcons();
    }

    function renderSummary(){
      let prev=0, pago=0;
      fixedExpensesCache.forEach(e=> prev += (e.estimatedValue||0));
      Object.values(monthlyPaymentsCache).forEach(p=> pago += (p.paidValue||0));
      const rest = prev - pago;
      totalPrevistoEl.textContent = formatCurrency(prev);
      totalPagoEl.textContent     = formatCurrency(pago);
      totalRestanteEl.textContent = formatCurrency(rest);
    }

    function renderCharts(){
      // Pie por conta
      const pieLabels = fixedExpensesCache.map(e=>e.name);
      const pieData   = fixedExpensesCache.map(e=>e.estimatedValue||0);
      const colors    = pieLabels.map((_,i)=> chartColors[i%chartColors.length]);

      const ctxPie = document.getElementById("chart-pie");
      if (chartPie) chartPie.destroy();
      chartPie = new Chart(ctxPie, {
        type: "pie",
        data: { labels: pieLabels, datasets: [{ data: pieData, backgroundColor: colors, borderWidth: 1 }] },
        options: { responsive:true, maintainAspectRatio:false }
      });

      // Bar Previsto vs Pago (soma)
      const previsto = pieData.reduce((a,b)=>a+b,0);
      const pago     = Object.values(monthlyPaymentsCache).reduce((s,p)=> s+(p.paidValue||0), 0);

      const ctxBar = document.getElementById("chart-bar");
      if (chartBar) chartBar.destroy();
      chartBar = new Chart(ctxBar, {
        type:"bar",
        data:{
          labels:["Mês atual"],
          datasets:[
            { label:"Previsto", data:[previsto] },
            { label:"Pago",     data:[pago] }
          ]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ position:"bottom" } },
          scales:{ y:{ beginAtZero:true } }
        }
      });
    }

    function renderExpenseList(){
      expenseList.innerHTML = "";

      if (fixedExpensesCache.length===0){
        expenseList.innerHTML = `<p class="text-gray-500 text-center py-4">Nenhuma conta fixa cadastrada.</p>`;
        return;
      }

      const currentDay = new Date().getDate();
      const isCurrentMonth = selectedDate.getMonth()=== (new Date()).getMonth() && selectedDate.getFullYear()===(new Date()).getFullYear();

      fixedExpensesCache
        .filter(expense=>{
          const nameOk = (expense.name||"").toLowerCase().includes(searchTerm);
          if (!nameOk) return false;
          const payment = monthlyPaymentsCache[expense.id];
          const isPaid = !!payment;
          const isLate = !isPaid && isCurrentMonth && (expense.dueDate||32) < currentDay;
          if (filterStatus==="paid" && !isPaid) return false;
          if (filterStatus==="pending" && isPaid) return false;
          if (filterStatus==="late" && !isLate) return false;
          return true;
        })
        .forEach(expense=>{
          const payment = monthlyPaymentsCache[expense.id];
          const isPaid = !!payment;
          const isLate = !isPaid && isCurrentMonth && (expense.dueDate||32) < currentDay;

          const badge = isPaid ? `<span class="px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-700">Pago</span>`
                     : isLate ? `<span class="px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-700">Atrasado</span>`
                              : `<span class="px-2 py-0.5 text-xs rounded-full bg-gray-100 text-gray-700">Pendente</span>`;

          const el = document.createElement("div");
          el.className = "border rounded-lg p-4 flex flex-col md:flex-row md:items-center justify-between gap-3";

          const left = `
            <div>
              <div class="flex items-center gap-2">
                <h4 class="font-semibold text-lg">${expense.name}</h4>
                ${badge}
              </div>
              <p class="text-sm text-gray-600">Previsto: ${formatCurrency(expense.estimatedValue)}</p>
              <p class="text-sm text-gray-500">Venc.: dia ${expense.dueDate||"—"} — <span class="text-gray-600">Cat.:</span> ${expense.category||"Outros"}</p>
              ${expense.notes ? `<p class="mt-1 text-xs text-gray-500">Notas: ${expense.notes}</p>` : ""}
            </div>
          `;

          let right = "";
          if (isPaid){
            right = `
              <div class="text-right">
                <div class="flex items-center justify-end gap-1 text-green-700">
                  <i data-lucide="check-circle" class="h-4 w-4"></i>
                  <span class="font-medium">Pago: ${formatCurrency(payment.paidValue)}</span>
                </div>
                <button data-action="undo" data-payment-id="${payment.id}" class="mt-2 text-sm text-indigo-600 hover:underline">Marcar como pendente</button>
              </div>
            `;
          }else{
            right = `
              <div class="flex gap-2">
                <button data-action="pay" data-expense-id="${expense.id}" data-estimated="${expense.estimatedValue}" class="bg-green-600 text-white px-3 py-2 rounded-lg flex items-center gap-1">
                  <i data-lucide="banknote"></i> Pagar
                </button>
                <button data-action="edit" data-expense-id="${expense.id}" class="bg-gray-100 border px-3 py-2 rounded-lg flex items-center gap-1">
                  <i data-lucide="pencil"></i> Editar
                </button>
                <button data-action="delete" data-expense-id="${expense.id}" data-expense-name="${expense.name}" class="bg-red-600 text-white px-3 py-2 rounded-lg flex items-center gap-1">
                  <i data-lucide="trash-2"></i> Excluir
                </button>
              </div>
            `;
          }

          el.innerHTML = `
            <div class="flex-1">${left}</div>
            <div>${right}</div>
          `;

          expenseList.appendChild(el);
        });
    }

    // Listeners da lista (delegação)
    expenseList.addEventListener("click", (ev)=>{
      const btn = ev.target.closest("button");
      if (!btn) return;
      const action = btn.dataset.action;
      if (action==="pay"){
        const expenseId = btn.dataset.expenseId;
        const est = parseFloat(btn.dataset.estimated||"0");
        payExpenseId.value = expenseId;
        payValue.value = est>0 ? est.toFixed(2) : "";
        openModal(payModal, payContent);
      }
      if (action==="edit"){
        const id = btn.dataset.expenseId;
        const e = fixedExpensesCache.find(x=>x.id===id);
        if (!e) return;
        editId.value = e.id;
        editName.value = e.name;
        editValue.value = e.estimatedValue;
        editDue.value = e.dueDate||"";
        editCategory.value = e.category||"Outros";
        editNotes.value = e.notes||"";
        openModal(editModal, editContent);
      }
      if (action==="delete"){
        const id = btn.dataset.expenseId;
        const name = btn.dataset.expenseName||"";
        confirmName.textContent = `"${name}"`;
        confirmOk.onclick = async ()=>{
          try{
            await deleteDoc(doc(db,colPath("fixedExpenses"), id));
            closeModal(confirmModal, confirmContent);
            showAlert("Conta excluída!");
          }catch{
            closeModal(confirmModal, confirmContent);
            showAlert("Erro ao excluir.", false);
          }
        };
        confirmCancel.onclick = ()=> closeModal(confirmModal, confirmContent);
        openModal(confirmModal, confirmContent);
      }
      if (action==="undo"){
        const pid = btn.dataset.paymentId;
        confirmName.textContent = "desfazer pagamento";
        confirmOk.onclick = async ()=>{
          try{
            await deleteDoc(doc(db,colPath("monthlyPayments"), pid));
            closeModal(confirmModal, confirmContent);
            showAlert("Pagamento desfeito.");
          }catch{
            closeModal(confirmModal, confirmContent);
            showAlert("Erro ao desfazer.", false);
          }
        };
        confirmCancel.onclick = ()=> closeModal(confirmModal, confirmContent);
        openModal(confirmModal, confirmContent);
      }
    });

    // Kickoff
    document.addEventListener("DOMContentLoaded", ()=>{ if (window.lucide) lucide.createIcons(); });
    init();
  </script>
</body>
</html>
